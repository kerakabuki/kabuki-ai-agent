# KABUKI LIVE × NAVI 強化構想メモ v1.1（改訂）

（注目演目×カウントダウン / LABO循環 / 正規化 / キャッシュ方針）

---

## 🎯 目的（変わらず）

KABUKI LIVE を「ニュースページ」ではなく

> 🎭 **歌舞伎のリアルタイムOS**
> へ進化させる。

本質：

> 📚 **演目ガイドを増やす循環（LIVE → NAVI → LABO）を作る**

---

# 1️⃣ LIVEトップ：注目演目ブロック（仕様更新）

## 1-1. 表示数（拡張余地を確保）

* 基本：**今月 1件 / 来月 1件**
* 拡張：最大 **2〜3件**まで表示可能な設計にする（UIは"折りたたみ"推奨）

### 表示例（ミニマル）

* 🎯 今月の注目：『〇〇』 ⏳千穐楽まであとX日（→NAVI）
* 🎯 来月の注目：『△△』 ⏳初日まであとY日（→NAVI）

### 拡張例（最大3件の見せ方）

* 先頭に1件だけ表示＋「他2件を見る（展開）」
  ※OS感を保ちつつ、同時期の名作にも対応

---

## 1-2. 「来月の注目」表示タイミング（自然さルール）

月初から来月を出すと早すぎる問題への対処。

**推奨ルール（実装簡単・自然）**

* **当月15日以降**：来月ブロックも表示
* **当月15日以前**：基本は今月のみ（ただし来月初日が近い場合は例外）

**例外ルール**

* 来月初日まで **14日以内**なら、月前半でも来月ブロックを表示してOK

---

# 2️⃣ 注目演目の選定ロジック（改訂）

## 2-1. 優先順位（変わらず）

1. NAVIに演目ガイドがある演目
2. 有名演目ホワイトリストにある演目
3. 当月スケジュール内で登場回数が多い演目

---

## 2-2. スコア方式（拡張しやすい形で確定）

```
score =
  NAVI存在      +1000
  有名演目      +100
  登場回数×10
  （任意）初日/千穐楽が近い +α
```

* 1000 / 100 / 10 の桁分けは維持（読みやすい＆重みが明確）
* 将来「話題」「注目タグ」「劇場の重要度」などを +α に足せる

---

## 2-3. 有名演目ホワイトリスト（暫定）

* 仮名手本忠臣蔵
* 義経千本桜
* 菅原伝授手習鑑
* 勧進帳
* 暫
* 助六由縁江戸桜
* 白浪五人男（弁天小僧）
* 夏祭浪花鑑
* 伽羅先代萩

※管理は将来的にKV/R2へ。まずはコード内定数でOK。

---

# 3️⃣ 表記ゆれ対策 normalizeTitle（精度強化）

## 3-1. まず入れる正規化（必須）

* 全角/半角スペース除去
* 記号除去（・、，．〜～—―-()（）【】『』「」等）
* 数字の正規化（全角→半角）
* 「見取」「通し狂言」などの一般語を削除（必要なら）

---

## 3-2. サブタイトル削除：正規表現だけに頼らず「既知パターンリスト」

歌舞伎は段名・幕名・場名が多いので、**"よくある末尾パターン"**をリスト化して剥がす。

### 既知パターン（例：末尾に付くものを削除）

* `○段目`（一段目〜十一段目 等）
* `○幕目`
* `○場`
* `○の場`
* `序幕 / 大序 / 二幕 / 三幕 / 終幕`
* `口上 / 立廻り / 大詰`
* `○返し` など（必要なら）

※ ここは「削りすぎ」に注意。
**方針：本体タイトル（通し狂言名）を残す**。
迷う場合は削らず残す（誤マッチよりマシ）。

---

## 3-3. 同義語・通称（段階的に）

将来：

* `忠臣蔵` → `仮名手本忠臣蔵`
* `弁天小僧` → `白浪五人男`
  のような **alias辞書** を持つと強い。

当面は Step2以降でOK（最初は過剰にやらない）。

---

# 4️⃣ スケジュールデータ：取得タイミング＆キャッシュ戦略（先に決める）

## 4-1. "リアルタイム"にしない前提

OS化のために毎分更新は不要。
むしろ安定・低コスト優先。

## 4-2. 推奨更新頻度（段階）

* **Step1**：毎日1回（Cron）更新で十分
* **Step2**：必要なら 6時間ごと（1日4回）
* **速報系だけ**別枠で短周期もあり（将来）

## 4-3. キャッシュ置き場（軽い順）

* KV：`schedule:YYYY-MM`（月単位）
* もしくはR2：`schedule/YYYY-MM.json`

※ "月単位"にすると注目演目計算が速い＆安定。

---

# 5️⃣ LABO：未整備候補の出し方（循環加速）

## 5-1. 基本（登場回数順）

来月スケジュールから演目を抽出し、

* ✅ ガイドあり
* ⚠️ ガイドなし（回数多い順）
  を出す。

---

## 5-2. 加速案（優先順位を上げる）

「ガイドなしで注目になれなかった演目」を優先表示する。

### 仕組み（簡単）

* 注目選定時に「NAVIが無くて落ちた候補」をKVに記録

  * `missed:YYYY-MM` に保存（上位N件）
* LABOの未整備候補で

  * `missed` を優先表示 → 次に登場回数順

これで「足りないところ」が明確になり、ガイドが増える速度が上がる。

---

# 6️⃣ 実装ロードマップ（改訂）

## Step1（最短ローンチ）

* 注目演目：**手動固定でもOK**
* カウントダウン表示
* NAVI誘導リンク
* スケジュール更新：**1日1回**
* normalizeTitle：最低限（記号・空白・段幕場削除は軽めに）

## Step2（自動選定へ）

* NAVI優先スコア選定
* 有名演目フォールバック
* 登場回数スコア
* normalizeTitle：既知パターンリスト導入

## Step3（循環強化）

* LABOで未整備候補（登場回数＋missed優先）
* alias辞書（通称→正式名）
* 表示件数を2〜3件に拡張（折りたたみ）

---

# 7️⃣ 完成形イメージ（ユーザー体験）

LIVEトップ：

* 今月の注目（千穐楽まで）
* 来月の注目（初日まで）※15日以降 or 近い場合
* それぞれ「演目ガイドを見る」でNAVIへ

→ NAVIが増えるほど、LIVEの注目が賢くなる
→ LABOで不足候補が見えるので、管理人が迷わず追加できる

---

## ✅ 次にやる実装（帰宅後の最短順）

1. **注目演目ブロックのUI枠**（今月/来月、各1件）
2. **カウントダウン計算**（最終日/初日）
3. **NAVI存在チェック**（catalog参照）
4. **スコア選定**（NAVI→有名→頻出）
5. **LABO用：来月の未整備候補出力**（まずはログ or JSON）

---

## 実装メモ：関数の雛形

必要な関数：

* `normalizeTitle(title)` — 表記ゆれ正規化
* `pickFeatured(schedule, catalog)` — 注目演目スコア選定
* `countdown(targetDate)` — カウントダウン計算
* `buildMissedList(schedule, catalog)` — LABO用の未整備候補生成
